<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cartera (Datos Dinámicos)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1 {
            color: #222;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        thead {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        tr:hover {
            background-color: #f0f0f0;
        }
        a {
            color: #0066cc;
            text-decoration: none;
            font-weight: bold;
            display: block; 
            height: 100%;
            width: 100%;
        }
        a:hover {
            text-decoration: underline;
        }
        
        /* --- AJUSTE DE ANCHOS DE COLUMNA --- */
        th:nth-child(1), td:nth-child(1) { width: 10%; } /* Siglas */
        th:nth-child(2), td:nth-child(2) { width: 15%; } /* Mercado */
        th:nth-child(3), td:nth-child(3) { width: 50%; } /* Nombre */
        th:nth-child(4), td:nth-child(4) { 
            width: 25%; 
            text-align: right; /* Alinea el valor a la derecha */
        }
        /* --- FIN DE AJUSTES --- */

        .cargando {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #888;
        }
    </style>
</head>
<body>

    <h1>Mi Cartera de Acciones y Bonos</h1>

    <table>
        <thead>
            <tr>
                <th>Siglas</th>
                <th>Mercado</th>
                <th>Nombre</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody id="tabla-cuerpo">
            <tr>
                <td colspan="4" class="cargando">Cargando datos desde Google Sheets...</td>
            </tr>
        </tbody>
    </table>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR9FD87KDQlxTg7zuTUWm0LVEswG2CyuWwfgbfTDvkHtgL40G-2kigq9FnHrmmMUekC_Nji87raOLGa/pub?gid=501210043&single=true&output=csv';

        document.addEventListener("DOMContentLoaded", () => {
            cargarDatosDeLaHoja();
        });

        // --- NUEVA FUNCIÓN PARA GENERAR LOS ENLACES ---
        function generarUrl(siglas, mercado) {
            // 1. Casos especiales (Bonos y ETFs no-Google)
            switch (siglas) {
                case 'UETW':
                    return 'https://www.justetf.com/en/etf-profile.html?isin=IE00BD4TXV59';
                case "US-T GOVT 5 May15'45":
                    return 'https://public.com/bonds/treasury/united-states/ust-5.0-05-15-2045-912810ul0';
                case "US-T GOVT 4,75 Aug15'55":
                    return 'https://public.com/bonds/treasury/united-states/ust-4.75-08-15-2055-912810um8';
            }

            // 2. Lógica para Google Finance
            let tickerLimpio = siglas.replace(/ /g, '.'); // Convierte "BRK B" en "BRK.B"
            let mercadoLimpio = mercado.replace('NASDAQ NM', 'NASDAQ').replace('NASDAQ NMB', 'NASDAQ'); // Acorta nombres
            
            return `https://www.google.com/finance/quote/${tickerLimpio}:${mercadoLimpio}`;
        }

        async function cargarDatosDeLaHoja() {
            const cuerpoTabla = document.getElementById("tabla-cuerpo");
            
            try {
                const respuesta = await fetch(`${csvUrl}&_=${new Date().getTime()}`); // Evita la caché
                if (!respuesta.ok) {
                    throw new Error("No se pudo cargar la hoja de cálculo. ¿Está publicada?");
                }
                
                const datosCsv = await respuesta.text();
                const filas = datosCsv.split("\n").filter(Boolean);
                
                let htmlParaTabla = "";
                
                filas.forEach(filaCsv => {
                    const columnas = filaCsv.split(",");
                    
                    // --- LIMPIEZA DE DATOS ---
                    // trim() quita espacios. replace() quita las comillas.
                    const siglas = columnas[0].trim().replace(/"/g, '');
                    const mercado = columnas[1].trim().replace(/"/g, '');
                    const nombre = columnas[2].trim().replace(/"/g, '');
                    const valor = columnas[3].trim().replace(/"/g, '');
                    
                    // --- NUEVA LÓGICA DE ENLACES ---
                    const url = generarUrl(siglas, mercado);
                    
                    // --- FORMATEO DE DECIMALES ---
                    let valorFormateado = valor; // Valor por defecto si no es un número
                    try {
                        const valorNumerico = parseFloat(valor);
                        if (!isNaN(valorNumerico)) {
                            // Si es un número, formatea a 2 decimales
                            valorFormateado = valorNumerico.toFixed(2);
                        }
                    } catch (e) {
                        // Si falla, se queda como texto (ej. "N/A")
                    }

                    // Crea el enlace
                    // El "valorFormateado" ahora es el texto clicable
                    const celdaValor = `<a href="${url}" target="_blank" rel="noopener noreferrer">${valorFormateado}</a>`;
                    
                    htmlParaTabla += `
                        <tr>
                            <td>${siglas}</td>
                            <td>${mercado}</td>
                            <td>${nombre}</td>
                            <td>${celdaValor}</td>
                        </tr>
                    `;
                });
                
                cuerpoTabla.innerHTML = htmlParaTabla;

            } catch (error) {
                console.error("Error al cargar datos:", error);
                cuerpoTabla.innerHTML = `<tr><td colspan="4" class="cargando" style="color: red;">Error al cargar: ${error.message}</td></tr>`;
            }
        }
    </script>
</body>
</html>
