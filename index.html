<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cartera (Datos Dinámicos)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1 {
            color: #222;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        thead {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        tr:hover {
            background-color: #f0f0f0;
        }
        a {
            color: #0066cc;
            text-decoration: none;
            font-weight: bold;
            display: block; /* Hace que toda la celda sea clicable si solo hay un enlace */
        }
        a:hover {
            text-decoration: underline;
        }
        /* Estilo para la celda de carga */
        .cargando {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #888;
        }
    </style>
</head>
<body>

    <h1>Mi Cartera de Acciones y Bonos</h1>

    <table>
        <thead>
            <tr>
                <th>Siglas</th>
                <th>Mercado</th>
                <th>Nombre</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody id="tabla-cuerpo">
            <tr>
                <td colspan="4" class="cargando">Cargando datos desde Google Sheets...</td>
            </tr>
        </tbody>
    </table>

    <script>
        // 1. Esta es tu URL de Google Sheets (formato CSV)
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR9FD87KDQlxTg7zuTUWm0LVEswG2CyuWwfgbfTDvkHtgL40G-2kigq9FnHrmmMUekC_Nji87raOLGa/pub?gid=501210043&single=true&output=csv';

        // 2. Esta función se ejecuta cuando se carga la página
        document.addEventListener("DOMContentLoaded", () => {
            cargarDatosDeLaHoja();
        });

        async function cargarDatosDeLaHoja() {
            const cuerpoTabla = document.getElementById("tabla-cuerpo");
            
            try {
                // 3. Intenta descargar el archivo CSV
                // Añadimos un parámetro 'cache-bust' para evitar la caché de GitHub/Google
                const respuesta = await fetch(`${csvUrl}&_=${new Date().getTime()}`);
                if (!respuesta.ok) {
                    throw new Error("No se pudo cargar la hoja de cálculo. ¿Está publicada correctamente?");
                }
                
                const datosCsv = await respuesta.text();
                
                // 4. Procesa el CSV
                const filas = datosCsv.split("\n").filter(Boolean); // Divide por líneas y quita líneas vacías
                
                let htmlParaTabla = ""; // Variable para ir guardando el HTML
                
                filas.forEach(filaCsv => {
                    // Divide cada línea por las comas
                    // Ojo: Esto es simple, si tus nombres tienen comas, fallará.
                    const columnas = filaCsv.split(","); 
                    
                    const siglas = columnas[0];
                    const mercado = columnas[1];
                    const nombre = columnas[2];
                    const valor = columnas[3];
                    const url = columnas[4];
                    
                    // 5. Crea el HTML para esta fila
                    let valorFormateado = valor;
                    try {
                        // Intenta formatear el valor como un número con 2 decimales
                        const valorNumerico = parseFloat(valor);
                        if (!isNaN(valorNumerico)) {
                            valorFormateado = valorNumerico.toFixed(2);
                        }
                    } catch (e) {
                        // Si falla, usa el valor tal cual (ej. "N/A", "#ERROR!")
                    }

                    // Crea el enlace
                    const celdaValor = `<a href="${url}" target="_blank" rel="noopener noreferrer">${valorFormateado}</a>`;
                    
                    // Añade la fila completa al HTML
                    htmlParaTabla += `
                        <tr>
                            <td>${siglas}</td>
                            <td>${mercado}</td>
                            <td>${nombre}</td>
                            <td>${celdaValor}</td>
                        </tr>
                    `;
                });
                
                // 6. Inserta todo el HTML nuevo en la tabla
                cuerpoTabla.innerHTML = htmlParaTabla;

            } catch (error) {
                // 7. Si algo falla, muestra un error
                console.error("Error al cargar datos:", error);
                cuerpoTabla.innerHTML = `<tr><td colspan="4" class="cargando" style="color: red;">Error al cargar: ${error.message}</td></tr>`;
            }
        }
    </script>
</body>
</html>
